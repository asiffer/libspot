#include "peaks.h"
#include "unity.h"
#include <stdlib.h>

static char buffer[256];

void test_peaks_init(void) {
    unsigned long const size = 10;
    struct Peaks Peaks;
    peaks_init(&Peaks, size);

    // TEST_ASSERT_DOUBLE_IS_NAN(Peaks.gamma);
    // TEST_ASSERT_DOUBLE_IS_NAN(Peaks.sigma);
    TEST_ASSERT_EQUAL_DOUBLE(0.0, Peaks.e);
    TEST_ASSERT_EQUAL_DOUBLE(0.0, Peaks.e2);
    TEST_ASSERT_DOUBLE_IS_NAN(Peaks.min);
    TEST_ASSERT_DOUBLE_IS_NAN(Peaks.max);
}

void test_peaks_push(void) {
    unsigned long const size = 10;
    double value = 1.0;
    struct Peaks Peaks;
    peaks_init(&Peaks, size);

    for (unsigned long i = 0; 2 * i < size; i++, value++) {
        peaks_push(&Peaks, value);
        peaks_push(&Peaks, -value);

        TEST_ASSERT_EQUAL_DOUBLE(-value, Peaks.min);
        TEST_ASSERT_EQUAL_DOUBLE(value, Peaks.max);
    }

    peaks_push(&Peaks, value);
    TEST_ASSERT_EQUAL_UINT64(size, peaks_size(&Peaks));
    TEST_ASSERT_EQUAL_DOUBLE(value, Peaks.max);

    peaks_push(&Peaks, -value);
    TEST_ASSERT_EQUAL_UINT64(size, peaks_size(&Peaks));
    TEST_ASSERT_EQUAL_DOUBLE(-value, Peaks.min);

    // ensure we update stats (at a moment the max will be erased)
    double const maxi = Peaks.max;
    for (unsigned long i = 0; i < size; i++) {
        peaks_push(&Peaks, Peaks.min);
    }
    TEST_ASSERT_NOT_EQUAL(maxi, Peaks.min);
}

void test_peaks_mean(void) {
    unsigned long const size = 50;
    double value = 1.0;
    struct Peaks Peaks;
    peaks_init(&Peaks, size);

    for (unsigned long i = 1; i <= size; i++) {
        peaks_push(&Peaks, (double)i);
        TEST_ASSERT_EQUAL_DOUBLE(0.5 * (double)(i + 1), peaks_mean(&Peaks));
    }

    double sum = (double)((size * (size + 1)) / 2);
    double s = 0.0;
    for (unsigned long i = 1; i <= size; i++) {
        peaks_push(&Peaks, 0);
        s += (double)(i);
        TEST_ASSERT_EQUAL_DOUBLE((sum - s) / (double)size, peaks_mean(&Peaks));
    }
}

void test_peaks_var(void) {
    unsigned long const size = 50;
    struct Peaks Peaks;
    peaks_init(&Peaks, size);

    for (double i = 1.0; (2 * i) <= (double)size; i++) {
        peaks_push(&Peaks, i);
        peaks_push(&Peaks, -i);
        TEST_ASSERT_EQUAL_DOUBLE((i + 1.0) * (2.0 * i + 1.0) / 6.0,
                                 peaks_var(&Peaks));
    }
}

void test_peaks_size(void) {
    unsigned long const size = 30;
    double value = 1.0;
    struct Peaks Peaks;
    peaks_init(&Peaks, size);

    for (unsigned long i = 0; i < size; i++) {
        peaks_push(&Peaks, value);
        TEST_ASSERT_EQUAL_UINT64(i + 1, peaks_size(&Peaks));
    }

    for (unsigned long i = 0; i < size; i++) {
        peaks_push(&Peaks, value);
        TEST_ASSERT_EQUAL_UINT64(size, peaks_size(&Peaks));
    }
}

void test_peaks_log_likelihood(void) {
    double const data[] = {
        2.69088505, 0.12453941, 2.58031455, 0.26470188, 0.23876629, 1.68905378,
        1.2505379,  0.33200188, 2.84758958, 0.24297855, 0.3450098,  0.32101662,
        0.12089122, 0.7164035,  0.5425824,  0.20664527, 0.0581949,  2.03191408,
        2.07599929, 5.22540713, 0.32671227, 0.71434937, 1.0574463,  0.59455242,
        0.99165061, 0.20906478, 0.81834691, 1.0088633,  0.36956706, 0.44051334,
        1.29948607, 1.07982264, 0.69960771, 1.63782766, 0.00928151, 2.79928485,
        1.01083295, 0.29819983, 1.39034273, 0.25910489, 1.34559763, 0.0398273,
        0.89512305, 0.25579795, 0.31943581, 0.48981371, 0.42049276, 0.28918703,
        0.98603651, 0.48819102, 1.64215752, 3.03929259, 1.34747888, 1.20114152,
        2.38322988, 2.2361624,  0.28119174, 0.48982254, 0.49429376, 0.27665337,
        1.82674921, 0.53125784, 1.55190225, 0.14409469, 0.27230352, 2.28613816,
        0.17754743, 0.30224318, 2.0015651,  0.31338594, 1.41915979, 0.63536818,
        3.48732647, 0.5751531,  0.4006696,  0.19423583, 0.87892606, 0.18775384,
        0.86774885, 0.94672435, 0.54495467, 2.85014065, 0.17650485, 1.18174772,
        0.16057681, 0.19215607, 1.00343105, 1.16639842, 3.63730016, 0.28603025,
        2.44834256, 0.6890435,  0.03245641, 3.34136442, 0.19618006, 0.47714146,
        2.43084965, 1.97320496, 3.29783831, 1.67527883, 0.05071108, 0.25935879,
        1.18400778, 1.11945738, 0.33665588, 3.2028886,  2.16815406, 0.12119212,
        0.24819533, 3.38230041, 0.07020174, 1.40270731, 1.59757208, 0.75592224,
        1.13011873, 0.0722796,  0.0214703,  1.86618791, 0.48055841, 0.36488323,
        0.55268398, 2.50916931, 0.88866371, 3.30365784, 0.58722021, 0.82376818,
        0.20350303, 1.72221252, 1.14569385, 0.32862842, 1.9202142,  0.39245517,
        0.79579552, 0.18260709, 0.15249771, 0.55216377, 2.33311955, 0.64271473,
        0.57576814, 0.10871037, 1.05438045, 1.33729791, 1.48883026, 0.07153502,
        2.00457198, 0.28610179, 2.49683122, 1.03368442, 0.08303643, 0.2331077,
        0.12989646, 0.07481105, 0.61707808, 0.60106274, 1.10914882, 1.5358802,
        1.05403642, 0.26270805, 0.41302594, 1.25316988, 1.40476572, 1.66389426,
        0.57571571, 1.55364339, 0.48958279, 0.9469729,  1.71979132, 0.47557783,
        0.92992235, 0.57502654, 3.68685451, 0.52453833, 0.42780783, 0.47470357,
        0.08196798, 1.01604928, 0.46919638, 0.1832935,  1.07156726, 1.12399693,
        0.36533477, 0.84430063, 2.85680559, 0.94334129, 0.32267835, 0.58871934,
        4.20302522, 0.48342571, 0.85459866, 0.09625508, 0.64026917, 1.23792146,
        0.53246991, 1.02855147, 0.43673462, 0.16567425, 0.0240515,  0.08980772,
        0.49422486, 1.66011908, 0.55863807, 0.31390188, 0.73470052, 0.38383842,
        0.27606976, 1.40718108, 0.54260999, 3.25703781, 0.21456511, 1.51627514,
        1.63090524, 0.25196824, 1.32728731, 0.08998416, 0.22868045, 0.45179107,
        0.52341851, 0.02306772, 0.69278941, 0.70059948, 0.6381404,  2.20397466,
        0.04829102, 1.99335929, 0.16074018, 1.82155303, 0.96867023, 3.3967586,
        0.49369004, 1.2727338,  0.62389451, 0.01060077, 0.73676106, 0.41758121,
        0.73750739, 0.73975024, 0.65365021, 1.559872,   0.11312822, 3.58806929,
        0.94898492, 0.5720275,  1.15982834, 2.85071688, 0.29702827, 0.76626338,
        0.52131355, 0.00622074, 0.15128405, 0.57893582, 0.09439903, 0.46175729,
        0.43904266, 1.90934536, 1.21870877, 0.0223568,  1.46131228, 1.84860823,
        0.55404091, 0.40512012, 0.86483173, 3.13222643, 0.71483851, 1.85605991,
        0.32266131, 1.96164386, 1.63269219, 0.20856814, 1.07110884, 0.2855919,
        0.29869615, 0.30797869, 0.54961452, 0.00865225, 3.54322238, 0.83063657,
        1.17321857, 0.2283853,  4.57291832, 0.37424592, 0.93751522, 2.84532633,
        0.42873124, 0.4901995,  1.75026648, 1.93240247, 0.09193016, 0.6363532,
        0.17204581, 1.04866554, 0.47751611, 0.06091819, 0.87343768, 0.30243565,
        6.01147984, 0.17983493, 3.44158965, 1.18171409, 0.99289932, 0.65565347,
        0.83383315, 0.36777183, 0.27864332, 0.17429522, 0.20451725, 1.00360682,
        0.10912357, 0.5881098,  0.19979381, 1.12795182, 1.48867853, 0.2684423,
        0.47901539, 0.10619913, 0.27499499, 0.83468316, 0.30091515, 0.48270265,
        2.20576784, 0.13884458, 1.13670359, 0.18317922, 0.02482579, 0.7380626,
        0.07826037, 0.09980065, 3.48761657, 0.30956165, 0.34535288, 5.17823498,
        3.76759379, 0.31323183, 0.48423039, 0.10335778, 3.3913116,  1.02282542,
        1.82627319, 1.86768126, 1.49048979, 0.54741529, 0.42037875, 1.22686551,
        3.91937197, 0.85501039, 2.36108625,
    };

    unsigned long const size = sizeof(data) / sizeof(double);
    struct Peaks Peaks;
    peaks_init(&Peaks, size);

    for (unsigned long i = 0; i < size; i++) {
        peaks_push(&Peaks, data[i]);
    }

    // gamma, sigma, log_likelihood
    double const params[][3] = {
        {0.0, 0.50, -459.321227182037},   {0.0, 0.65, -388.65451277519406},
        {0.0, 0.80, -359.55110259360896}, {0.0, 0.95, -349.9127631600941},
        {0.0, 1.10, -350.3624686121367},  {0.0, 1.25, -356.3673269934896},
        {0.0, 1.40, -365.53185180403926}, {0.0, 1.55, -376.5066622922867},
        {0.0, 1.70, -388.4952773444541},  {0.0, 1.85, -401.0112088578111},
        {0.0, 2.00, -413.7500284119857},  {0.1, 0.50, -413.14369980017716},
        {0.1, 0.65, -369.6190715295991},  {0.1, 0.80, -353.25322271154624},
        {0.1, 0.95, -350.2378858844184},  {0.1, 1.10, -354.3485581711525},
        {0.1, 1.25, -362.4446544104392},  {0.1, 1.40, -372.8134429796908},
        {0.1, 1.55, -384.46726459376754}, {0.1, 1.70, -396.81297144837924},
        {0.1, 1.85, -409.4838159539396},  {0.1, 2.00, -422.24854873252036},
        {0.2, 0.50, -393.2369467897064},  {0.2, 0.65, -363.1298124102949},
        {0.2, 0.80, -353.5294048764377},  {0.2, 0.95, -354.18915757502043},
        {0.2, 1.10, -360.37686352843264}, {0.2, 1.25, -369.6607050357058},
        {0.2, 1.40, -380.69580934382856}, {0.2, 1.55, -392.6984733087475},
        {0.2, 1.70, -405.1945249512819},  {0.2, 1.85, -417.8894484928384},
        {0.2, 2.00, -430.59726380374957}, {0.3, 0.50, -384.18908666475113},
        {0.3, 0.65, -362.25109993986547}, {0.3, 0.80, -356.8765847581439},
        {0.3, 0.95, -359.85748449500375}, {0.3, 1.10, -367.35160500660027},
        {0.3, 1.25, -377.364151948431},   {0.3, 1.40, -388.7833913811189},
        {0.3, 1.55, -400.95787993395055}, {0.3, 1.70, -413.4920948090361},
        {0.3, 1.85, -426.14004220770886}, {0.3, 2.00, -438.7465582009827},
        {0.4, 0.50, -380.78498835421465}, {0.4, 0.65, -364.35902362914004},
        {0.4, 0.80, -361.8598433127441},  {0.4, 0.95, -366.41452636283526},
        {0.4, 1.10, -374.77757858986354}, {0.4, 1.25, -385.25288953431},
        {0.4, 1.40, -396.8906432606534},  {0.4, 1.55, -409.1324989927333},
        {0.4, 1.70, -421.6389252323942},  {0.4, 1.85, -434.19879348376134},
        {0.4, 2.00, -446.6792472774315},  {0.5, 0.50, -380.66889688337494},
        {0.5, 0.65, -368.2039831085471},  {0.5, 0.80, -367.7693663615324},
        {0.5, 0.95, -373.4397620992652},  {0.5, 1.10, -382.3996627280118},
        {0.5, 1.25, -393.17088724484614}, {0.5, 1.40, -404.9229877468974},
        {0.5, 1.55, -417.1668503708578},  {0.5, 1.70, -429.6048682836566},
        {0.5, 1.85, -442.05216330476276}, {0.5, 2.00, -454.3927423331012},
        {0.6, 0.50, -382.6031286237045},  {0.6, 0.65, -373.1099851835514},
        {0.6, 0.80, -374.21379802278767}, {0.6, 0.95, -380.6991327445567},
        {0.6, 1.10, -390.0760202062547},  {0.6, 1.25, -401.03270318407687},
        {0.6, 1.40, -412.8305353306658},  {0.6, 1.55, -425.033946268393},
        {0.6, 1.70, -437.3778997254094},  {0.6, 1.85, -449.69797630523624},
        {0.6, 2.00, -461.8913510398413},  {0.7, 0.50, -385.8722854280594},
        {0.7, 0.65, -378.68000122313975}, {0.7, 0.80, -380.9616006419556},
        {0.7, 0.95, -388.05445342530584}, {0.7, 1.10, -397.7241140140418},
        {0.7, 1.25, -408.7902791282709},  {0.7, 1.40, -420.5871773393998},
        {0.7, 1.55, -432.72190717640274}, {0.7, 1.70, -444.95546027441424},
        {0.7, 1.85, -457.1397940138694},  {0.7, 2.00, -469.18262959466716},
        {0.8, 0.50, -390.0345603116509},  {0.8, 0.65, -384.66709752088497},
        {0.8, 0.80, -387.8689804290147},  {0.8, 0.95, -395.4209475132627},
        {0.8, 1.10, -405.2947409149715},  {0.8, 1.25, -416.41663356292344},
        {0.8, 1.40, -428.1801522470472},  {0.8, 1.55, -440.22720689263895},
        {0.8, 1.70, -452.34005953302017}, {0.8, 1.85, -464.384059738076},
        {0.8, 2.00, -476.275548824264},   {0.9, 0.50, -394.8035399133563},
        {0.9, 0.65, -390.91115702034},    {0.9, 0.80, -394.8435477816544},
        {0.9, 0.95, -402.7453692448699},  {0.9, 1.10, -412.758421863874},
        {0.9, 1.25, -423.8972020696713},  {0.9, 1.40, -435.60445556751154},
        {0.9, 1.55, -447.55103834780823}, {0.9, 1.70, -459.5369148702616},
        {0.9, 1.85, -471.43857969106324}, {0.9, 2.00, -483.17953936000924},
        {1.0, 0.50, -399.98657284746105}, {1.0, 0.65, -397.3050896430853},
        {1.0, 0.80, -401.8245402225786},  {1.0, 0.95, -409.9939176060436},
        {1.0, 1.10, -420.0977981671999},  {1.0, 1.25, -431.22496271619997},
        {1.0, 1.40, -442.85968281583274}, {1.0, 1.55, -454.69726511800206},
        {1.0, 1.70, -466.55263235756723}, {1.0, 1.85, -478.31169086001637},
        {1.0, 2.00, -489.9039878738363},
    };

    unsigned long nb_confs = sizeof(params) / (3 * sizeof(double));
    double llhood = 0.0;
    double target = 0.0;
    double gamma = 0.0;
    double sigma = 0.0;
    // -349.22850223760906
    for (unsigned long i = 0; i < nb_confs; ++i) {
        gamma = params[i][0];
        sigma = params[i][1];
        target = params[i][2];
        llhood = log_likelihood(&Peaks, gamma, sigma);
        TEST_ASSERT_DOUBLE_WITHIN(1e-6, target, llhood);
    }
    // double llhood = log_likelihood(&Peaks, gamma, sigma);
    // sprintf(buffer, "%.6f != %.6f", llhood, -349.22850223760906);
    // TEST_ASSERT_DOUBLE_WITHIN_MESSAGE(0.000001, -349.22850223760906, llhood,
    //                                   buffer);
    // TEST_ASSERT_DOUBLE_WITHIN(1e-6, -349.22850223760906, llhood);
}

void test_peaks_free(void) {
    unsigned long const size = 10;
    struct Peaks Peaks;
    peaks_init(&Peaks, size);

    Peaks.e = 10.0;
    Peaks.e2 = 5.0;
    Peaks.min = -5.0;
    Peaks.max = 17.2;

    peaks_free(&Peaks);

    TEST_ASSERT_DOUBLE_IS_NAN(Peaks.e);
    TEST_ASSERT_DOUBLE_IS_NAN(Peaks.e2);
    TEST_ASSERT_DOUBLE_IS_NAN(Peaks.min);
    TEST_ASSERT_DOUBLE_IS_NAN(Peaks.max);
}

void setUp(void) { set_allocators(malloc, free); }

void tearDown(void) {}

int main(void) {
    UNITY_BEGIN();
    RUN_TEST(test_peaks_init);
    RUN_TEST(test_peaks_push);
    RUN_TEST(test_peaks_mean);
    RUN_TEST(test_peaks_var);
    RUN_TEST(test_peaks_size);
    RUN_TEST(test_peaks_log_likelihood);
    RUN_TEST(test_peaks_free);
    return UNITY_END();
}
name: build

on:
  pull_request:

jobs:
  build:
    name: Build (x64)
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v2

      - name: Install build dependencies
        run: sudo apt update -y && sudo apt install -y build-essential

      - name: Build shared library
        run: make

      - name: Build static library
        run: make static

      - uses: actions/upload-artifact@v3
        with:
          name: libspot
          path: |
            lib/libspot.so*
            lib/libspot.a*
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: checkout repo
        uses: actions/checkout@v2

      - name: Get artifacts
        uses: actions/download-artifact@v2
        with:
          name: libspot

      - name: Create symlink
        run: ln -s lib/libspot.so* lib/libspot.so

      - name: Test
        run: make test

  install:
    name: Install
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: checkout repo
        uses: actions/checkout@v2

      - name: Get artifacts
        uses: actions/download-artifact@v2
        with:
          name: libspot

      - name: Install
        run: sudo make install

      - name: Test simple program
        run: make test_post_install

  # release:
  #   name: Release
  #   runs-on: ubuntu-latest
  #   needs: build
  #   if: github.ref == 'refs/heads/master'
  #   steps:
  #     - uses: "marvinpinto/action-automatic-releases@latest"
  #       with:
  #         repo_token: "${{ secrets.GITHUB_TOKEN }}"
  #         prerelease: false
  #         title: "New release"
  #         files: |
  #           lib/libspot.so*
  #           lib/libspot.a*
